---
title: Hexo on vps
date: 2018-01-07 08:32:14
tags: 
- hexo
- vps
- git
---
本文描述的是在本地生成hexo后，git发布到vps，自动部署到nginx网站下，并使用https。
 
References:
1.<https://benwong.cn/tech/hexo-init.html>
2.<https://benwong.cn/tech/coding-pages.html>
3.<https://pondof.fish/d/31>
4.<https://yanzai.me/hexo-git-deploy.html>
5.<https://benwong.cn/tech/Hexo-in-VPS.html>
6.<https://diamondfsd.com/article/e221b455-b0e7-40b7-a6c7-9bb7e3e35657>

## PC and Vps
PC: Gnu/Debian 
Vps: vultr or bwh1

## 本地PC 搭建GIT SSH-KEYS NODE.JS 以及 HEXO此处省略

修改`hexo/_config.yml`

```
# Deployment
## Docs: https://hexo.io/docs/deployment.html
deploy:
- type: git
  repo: git@github.com:username/username.github.io.git
  branch: master
  name: username
  email: username@gmail.com
- type: git
  message: update
  repo: ssh://user@VPS_IP:22/~/hexo.git
  branch: master
```

## 在vps上安装Git-core nginx

`apt install git-core nginx`
** 保存认证密钥 **
接下来要把本地的 ssh 公钥上传到 VPS 。
vps执行：
```
cd ~
mkdir .ssh && cd .ssh
touch authorized_keys
vi authorized_keys
```
现在要打开本地的 `Git Bash`，输入`cat ~/.ssh/id_rsa.pub`，把里面的内容复制下来粘贴到上面打开的文件里。
```
cd ~
mkdir hexo.git
cd hexo.git
git init --bare
```
** 创建hexo博客目录 **
以 root 用户的身份进入 `/var/www` ，然后新建一个文件夹，就名为 `blog` 好了，最后授予 `user` 这个用户完整的权限。 `user`是你自己的用户名。

```
su
cd /var/www
mkdir blog
chmod 0755 blog
chown user:user -R /var/www/blog
```
## 本地建立到VPS的链接
首先，我们需要在本地用户的目录下，建立一个 `.ssh` 文件夹，然后向里面写入 `config` 。
```
cd ~
mkdir .ssh
chmod 0755 .ssh
nano .ssh/config
```

```
Host 127.0.0.1             # VPS 的 IP
HostName 127.0.0.1         # VPS 的 IP
User user                  # 用户
Port 1270                  # SSH 端口
IdentityFile ~/.ssh/id_rsa # SSH Key
```
然后，重启 Git Bash ，试试看下面的代码能否正常运行

`ssh user@127.0.0.1`



##  VPS - 配置更新事件 (hook)
```
这里的更新事件，指的是 Git hooks 中的 post-receive ，在我们向 VPS 推送更新的时候会被作为一个 sh 文件触发，因而语法与 sh 相同。
```
使用 `ssh`命令登陆上 `VPS` 之后，输入如下命令
`nano ~/hexo.git/hooks/post-receive`

```
!/bin/bash

GIT_REPO=~/hexo.git                      # 空 Git 仓库的文件夹，触发 hook 时已经存入了内容
TMP_GIT_CLONE=/tmp/hexo                  # 缓存文件夹，存在 /tmp 下可以随意读写
PUBLIC_WWW=/var/www/blog                 # 之前创建的 blog 文件夹，用作网站主目录
rm -rf ${TMP_GIT_CLONE}                  # 删除缓存的全部内容
git clone $GIT_REPO $TMP_GIT_CLONE       # 将 Git 仓库被上传的内容写入缓存
rm -rf ${PUBLIC_WWW}/*                   # 删除网站主目录全部内容
cp -rf ${TMP_GIT_CLONE}/* ${PUBLIC_WWW}  # 将缓存目录所有内容复制到主目录
```
保存退出，然后给脚本加上执行权限：
`chmod +x ~/hexo.git/hooks/post-receive`

## 免费从HTTP升级为HTTPS
### 申请个域名并做A记录
COM域名(便宜)建议到这里申请<https://www.namesilo.com> 

首先你有个自己的域名，然后在域名管理中设置两个`A`记录，一个是`@`的`A`记录到`VPS`的IP地址，一个是`www`的`A`记录到IP地址，其他请清空。设置后等待10分钟左右，再进行下一步。
### Let's Encrypt 简介
如果要启用HTTPS，我们就需要从证书授权机构(以下简称CA) 处获取一个证书，Let's Encrypt 就是一个 CA。我们可以从 Let's Encrypt 获得网站域名的免费的证书。这篇文章也主要讲的是通过 Let's Encrypt + Nginx 来让网站升级到HTTPS。

### Certbot 简介
Certbot 是Let's Encrypt官方推荐的获取证书的客户端，可以帮我们获取免费的Let's Encrypt 证书。Certbot 是支持所有 Unix 内核的操作系统的，个人博客的服务器系统是CentOS 7，这篇教程也是通过在个人博客上启用HTTPS的基础上完成的。
### 在VPS中获取免费证书
`apt install certbot`
certbot 有一种模式 --standalone ， 这种模式不需要指定网站根目录，他会自动启用服务器的443端口，来验证域名的归属。我们有其他服务（例如nginx）占用了443端口，就必须先停止这些服务，在证书生成完毕后，再启用。
`certbot certonly --standalone -d yoursite.com -d www.yoursite.com
`
证书生成完毕后，我们可以在 /etc/letsencrypt/live/ 目录下看到对应域名的文件夹，里面存放了指向证书的一些快捷方式。

这时候我们的第一生成证书已经完成了，接下来就是配置我们的web服务器，启用HTTPS。

## VPS-配置NGINX
```
NGINX 是一个功能强大的 HTTP 反向代理服务器，支持负载均衡等等特性，
```
切换到 root 用户，进入到 NGINX 的配置目录，编辑默认配置文件
```
cd /etc/nginx/sites-available
vim default
```
### 自动更新 SSL 证书
配置完这些过后，我们的工作还没有完成。 `Let's Encrypt` 提供的证书只有90天的有效期，我们必须在证书到期之前，重新获取这些证书，`certbot` 给我们提供了一个很方便的命令，那就是 `certbot renew`。
通过这个命令，他会自动检查系统内的证书，并且自动更新这些证书。
我们可以运行这个命令测试一下
这是因为我的`yoursite.com`生成证书的时候使用的是 `--standalone `模式，验证域名的时候，需要启用443端口，这个错误的意思就是要启用的端口已经被占用了。 这时候我必须把nginx先关掉，才可以成功。果然，我先运行 `service nginx stop` 运行这个命令，就没有报错了，所有的证书都刷新成功。

证书是90天才过期，我们只需要在过期之前执行更新操作就可以了。 这件事情就可以直接交给定时任务来完成。linux 系统上有 `cron` 可以来搞定这件事情。
我新建了一个文件 `certbot-auto-renew-cron`， 这个是一个 `cron` 计划，这段内容的意思就是 每隔 两个月的 凌晨 2:15 执行 更新操作。
`nano ~/certbot-auto-renew-cron`

`15 2 * */2 * certbot renew --pre-hook "service nginx stop" --post-hook "service nginx start"`

`--pre-hook` 这个参数表示执行更新操作之前要做的事情，因为我有 --`standalone` 模式的证书，所以需要 停止 `nginx` 服务，解除端口占用。
`--post-hook` 这个参数表示执行更新操作完成后要做的事情，这里就恢复 nginx 服务的启用

最后我们用 crontab 来启动这个定时任务
`crontab certbot-auto-renew-cron`

在这个文件中，你可以看到 NGINX 默认的配置，我们则需要把这个默认的配置全部删掉改成自己的。
```
server {
        listen 80;
        listen [::]:80;
        # ====== 1 ======
        server_name yoursite.com;
        # ====== 1 ======
        return 301 https://$server_name$request_uri;
}
server {
        # SSL configuration

        listen 443 ssl;
        listen [::]:443 ssl;

        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        # ====== 2 ======
        root /var/www/blog;
        # ====== 2 ======

        # ====== 3 ======
        ssl_certificate /etc/letsencrypt/live/yoursite.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/yoursite.com/privkey.pem;
        # ====== 3 ======

        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;

        # intermediate configuration. tweak to your needs.
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

        # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
        add_header Strict-Transport-Security max-age=15768000;

        # OCSP Stapling ---
        # fetch OCSP records from URL in ssl_certificate and cache them
        ssl_stapling on;
        ssl_stapling_verify on;
  
        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        # ====== 1 ======
        server_name yoursite.com;
        # ====== 1 ======

        location ~* ^.+\.(ico|gif|jpg|jpeg|png)$ {
                # ====== 2 ======
                root /var/www/blog;
                # ====== 2 ======
                access_log   off;
                expires      1d;
        }
        location ~* ^.+\.(css|js|txt|xml|swf|wav)$ {
                # ====== 2 ======
                root /var/www/blog;
                # ====== 2 ======
                access_log   off;
                expires      10m;
        }
        location / {
                # ====== 2 ======
                root /var/www/blog;
                # ====== 2 ======
                if (-f $request_filename) {
                        rewrite ^/(.*)$  /$1 break;
                }
        }
}
```
备注：
```
1: 域名
2: 网页主目录，就是之前创建的 blog 文件夹
3: 你的 SSL 证书和 SSL key
```

完成之后，保存退出，重启 NGINX 。
`/etc/init.d/nginx restart`

## 利用 Hexo 的 Git 部署工具部署到 VPS
如果没有安装 Hexo 的 Git 部署工具，要切换到本地 hexo 目录，先安装 Hexo 的 Git 部署工具，Hexo 3.0 开始，部署工具需要单独安装：
`npm install hexo-deployer-git --save`
然后，在本地，切换到要部署的hexo网站目录下，执行以下命令部署：
```
hexo clean
hexo g -d
```
部署成功会有 INFO Deploy done: git 的提示。

## 完成之后

Hexo 的基本使用非常简单，只需要 `hexo new "New Post"` 就能新建一篇文章，写完之后` hexo clean && hexo g `再 `hexo d` 上传，期间可以 `hexo s --debug `测试。想要使用主题的话，只需把主题文件夹丢到 Hexo 本地文件夹的 themes 然后在 `_config.yml` 里 `theme:` 后面改成主题就可以了。若有任何问题，请随时提出。


